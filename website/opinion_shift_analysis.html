{% extends "base.html" %}
{% block title %}Opinion Shift Analysis{% endblock %}

{% block content %}
<style>
    .shift-positive {
        color: #198754;
        font-weight: bold;
    }
    .shift-negative {
        color: #dc3545;
        font-weight: bold;
    }
    .shift-neutral {
        color: #6c757d;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
    }
    .openness-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
    }
</style>

<section class="py-3 text-center container">
    <div class="row py-lg-4">
        <div class="col-lg-8 mx-auto">
            <h1 class="fw-light" data-i18n="shift_title">Your Opinion Journey</h1>
            <p class="lead text-body-secondary">
                <span data-i18n="shift_intro_prefix">
                    See how your perspective evolved through the discussion on
                </span>
                <strong>{{ user.topic|capitalize|replace('_', ' ') }}</strong>
            </p>
        </div>
    </div>
</section>

<div class="album py-3 bg-body-tertiary">
    <div class="container">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                
                <!-- Two-Column Layout for Metrics -->
                <div class="row mb-4">
                    <!-- Overall Shift Summary -->
                    {% if avg_shift is not none %}
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm metric-card h-100">
                            <div class="card-body text-center p-4">
                                <h3 class="mb-3" data-i18n="shift_overall_title">Overall Opinion Shift</h3>
                                <div class="display-4 mb-2">
                                    {% if avg_shift > 0 %}+{% endif %}{{ avg_shift|float|round(2) }}
                                </div>
                                {% if avg_shift > 0.5 %}
                                    <p class="mb-0" data-i18n="shift_overall_positive">
                                        Your views became more positive after the discussion
                                    </p>
                                {% elif avg_shift|abs > 0.5 %}
                                    <p class="mb-0" data-i18n="shift_overall_negative">
                                        Your views became more critical after the discussion
                                    </p>
                                {% else %}
                                    <p class="mb-0" data-i18n="shift_overall_stable">
                                        Your views remained relatively stable
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Openness Score Card -->
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm openness-card h-100">
                            <div class="card-body text-center p-4">
                                <h3 class="mb-3" data-i18n="shift_openness_title">Your Openness Score</h3>
                                {% if openness_score is not none and openness_score != 'None' %}
                                    <div class="display-4 mb-2">
                                        {{ openness_score|round(1) }}
                                    </div>
                                    <p class="mb-0">
                                        {% if openness_category %}
                                            <span data-i18n="shift_openness_category_prefix">Category:</span>
                                            <strong> {{ openness_category }} </strong>
                                        {% else %}
                                            <span class="opacity-75" data-i18n="shift_openness_category_na">
                                                Category not available
                                            </span>
                                        {% endif %}
                                    </p>
                                    <small class="mt-2 d-block opacity-75" data-i18n="shift_openness_based_on">
                                        Based on your initial questionnaire responses
                                    </small>
                                {% else %}
                                    <div class="display-6 mb-2 text-muted" data-i18n="shift_openness_not_available">
                                        Not Available
                                    </div>
                                    <p class="mb-0 small">
                                        <span data-i18n="shift_openness_score_value_prefix">Score value:</span>
                                        {{ openness_score }}
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Line Chart: Before vs After -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4" data-i18n="shift_chart_title">Before vs After Discussion</h4>
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>

                <!-- Bar Chart: Detailed Question-by-Question Shift -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4" data-i18n="shift_shift_chart_title">Question-by-Question Shift Analysis</h4>
                        <p class="text-muted mb-3" data-i18n="shift_shift_chart_hint">
                            Green bars indicate positive shifts, red bars indicate negative shifts
                        </p>
                        <canvas id="shiftChart"></canvas>
                    </div>
                </div>

                <!-- Grouped Bar Chart: Before/After Comparison -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h4 class="card-title mb-4" data-i18n="shift_comparison_title">Detailed Before/After Comparison</h4>
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <a href="{{ url_for('views.reward') }}" class="btn btn-primary btn-lg" data-i18n="shift_continue_reward_btn">
                        Continue to Reward
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const questionsData = {{ questions|tojson }};
    const beforeData = {{ before_values|tojson }};
    const afterData = {{ after_values|tojson }};
    const shiftsData = {{ shifts|tojson }};

    const labels = questionsData.map((q, i) => 'Q' + (i + 1));

    // current language & helper using global `translations` from base.html
    const lang = (localStorage.getItem("language") || "en");
    const t = (key, fallback) => {
        try {
            if (typeof translations !== "undefined" &&
                translations[lang] &&
                translations[lang][key] !== undefined) {
                return translations[lang][key];
            }
        } catch (e) {}
        return fallback;
    };

    // Value label mapping (reuses same keys as sliders)
    const valueMap = {
        -2: t('scale_strongly_disagree', 'Strongly Disagree'),
        -1: t('scale_disagree', 'Disagree'),
        0: t('scale_neutral', 'Neutral'),
        1: t('scale_agree', 'Agree'),
        2: t('scale_strongly_agree', 'Strongly Agree')
    };

    // 1. Line Chart: Before vs After
    const lineCtx = document.getElementById('lineChart');
    if (lineCtx) {
        new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: t('shift_chart_before_label', 'Before Discussion'),
                        data: beforeData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.3
                    },
                    {
                        label: t('shift_chart_after_label', 'After Discussion'),
                        data: afterData,
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                aspectRatio: 2.5,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function (ctx) {
                                return questionsData[ctx[0].dataIndex];
                            },
                            label: function (context) {
                                const value = context.parsed.y;
                                return `${context.dataset.label}: ${valueMap[value] ?? value}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: -2,
                        max: 2,
                        ticks: {
                            stepSize: 1,
                            callback: function (value) {
                                return valueMap[value] ?? value;
                            }
                        },
                        title: {
                            display: true,
                            text: t('shift_axis_agreement_level', 'Agreement Level')
                        }
                    },
                    x: {
                        grid: { display: false },
                        title: {
                            display: true,
                            text: t('shift_axis_questions', 'Questions')
                        }
                    }
                }
            }
        });
    }

    // 2. Bar Chart: Opinion Shifts
    const shiftCtx = document.getElementById('shiftChart');
    if (shiftCtx) {
        // Color bars based on positive/negative shift
        const barColors = shiftsData.map(shift => {
            if (shift === null) return 'rgb(200, 200, 200)';
            return shift > 0 ? 'rgba(25, 135, 84, 0.8)' :
                   shift < 0 ? 'rgba(220, 53, 69, 0.8)' :
                               'rgba(108, 117, 125, 0.8)';
        });

        new Chart(shiftCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: t('shift_shift_dataset_label', 'Opinion Shift'),
                    data: shiftsData,
                    backgroundColor: barColors,
                    borderColor: barColors.map(c => c.replace('0.8', '1')),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                aspectRatio: 2.5,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function (ctx) {
                                return questionsData[ctx[0].dataIndex];
                            },
                            label: function (context) {
                                const shift = context.parsed.y;
                                if (shift === null) return t('shift_no_data', 'No data');
                                const direction =
                                    shift > 0
                                        ? t('shift_direction_more_positive', '↑ More positive')
                                        : shift < 0
                                            ? t('shift_direction_more_negative', '↓ More negative')
                                            : t('shift_direction_no_change', '→ No change');
                                return `${t('shift_shift_prefix', 'Shift: ')}${shift > 0 ? '+' : ''}${shift} ${direction}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: t('shift_axis_opinion_change', 'Opinion Change')
                        },
                        ticks: {
                            stepSize: 1
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: t('shift_axis_questions', 'Questions')
                        }
                    }
                }
            }
        });
    }

    // 3. Grouped Bar Chart: Before/After Comparison
    const comparisonCtx = document.getElementById('comparisonChart');
    if (comparisonCtx) {
        new Chart(comparisonCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: t('shift_chart_before_label', 'Before Discussion'),
                        data: beforeData,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgb(75, 192, 192)',
                        borderWidth: 2
                    },
                    {
                        label: t('shift_chart_after_label', 'After Discussion'),
                        data: afterData,
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgb(153, 102, 255)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                aspectRatio: 2.5,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function (ctx) {
                                return questionsData[ctx[0].dataIndex];
                            },
                            label: function (context) {
                                const value = context.parsed.y;
                                return `${context.dataset.label}: ${valueMap[value] ?? value}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: -2,
                        max: 2,
                        ticks: {
                            stepSize: 1,
                            callback: function (value) {
                                return valueMap[value] ?? value;
                            }
                        },
                        title: {
                            display: true,
                            text: t('shift_axis_agreement_level', 'Agreement Level')
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: t('shift_axis_questions', 'Questions')
                        }
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}
