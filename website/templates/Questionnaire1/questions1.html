{% extends "base.html" %}
{% block title %}Opinion Questionnaire{% endblock %}
{% block content %}
<section class="py-3 text-center container">
    <div class="row py-lg-4">
        <div class="col-lg-8 mx-auto">
            <h1 class="fw-light">Political Dialogue Questionnaire</h1>
            <p class="lead text-body-secondary">
                To find a suitable discussion partner with an opposing viewpoint, please rate your agreement with the following 15 statements on a scale from -2 (Strongly Disagree) to +2 (Strongly Agree).
            </p>
            <p class="lead text-body-secondary">
                You selected the topic: <b>{{ user.topic|default('unknown')|capitalize|replace('_', ' ') }}</b>
            </p>
        </div>
    </div>
</section>

<div class="album py-3 bg-body-tertiary">
    <div class="container">
        {# Replace 'questionnaire.submit' with your actual route endpoint #}
        <form method="POST" action="{{ url_for('views.questions1') }}">

            {{ csrf_token() }} {# REQUIRED: Add CSRF protection #}
            
            {# Display validation errors if any #}
            {% if form_errors %}
            <div class="alert alert-danger col-md-10 mx-auto" role="alert">
                Please correct the following errors:
                <ul class="mb-0">
                {% for field, errors in form_errors.items() %}
                    <li><strong>{{ field }}:</strong> {{ errors|join(', ') }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}

            <div class="py-3 col-md-10 shadow-sm rounded mx-auto bg-white p-4">
                
                <h3 class="fw-bold mb-4">Part A: Openness to Different Views (5 Questions)</h3>
                <p class="lead text-body-secondary">Your answers here determine if you are eligible to participate.</p>

                {% set name_prefix = 'attitude' %}
                
                {# Attitude Question 1 #}
                {% set question_number = 1 %}
                {% set question_text = "I am open to hearing opinions on this topic that differ from my own." %}
                {% include 'opinion_slider_content.html' with context %}

                {# Attitude Question 2 #}
                {% set question_number = 2 %}
                {% set question_text = "I can see both positive and negative aspects of this issue." %}
                {% include 'opinion_slider_content.html' with context %}

                {# Attitude Question 3 #}
                {% set question_number = 3 %}
                {% set question_text = "I would be willing to adjust my view if presented with convincing evidence." %}
                {% include 'opinion_slider_content.html' with context %}

                {# Attitude Question 4 #}
                {% set question_number = 4 %}
                {% set question_text = "People who disagree with me on this topic may still have valid concerns." %}
                {% include 'opinion_slider_content.html' with context %}

                {# Attitude Question 5 #}
                {% set question_number = 5 %}
                {% set question_text = "I believe it's possible to find common ground between opposing views on this issue." %}
                {% include 'opinion_slider_content.html' with context %}


                <h3 class="fw-bold mt-5 mb-4">Part B: Topic-Specific Attitude (10 Questions)</h3>
                <p class="lead text-body-secondary">These answers will be used to match you with a suitable partner with an opposing view.</p>

                {% set name_prefix = 'match' %}
                
                {# Matching Question 1 #}
                {% set question_number = 1 %}
                {% set question_text = "I generally support the main idea or goal of this topic." %}
                {% include 'opinion_slider_content.html' with context %}

                {# Matching Question 2 #}
                {% set question_number = 2 %}
                {% set question_text = "I believe the benefits of this topic outweigh its risks." %}
                {% include 'opinion_slider_content.html' with context %}

                {# Matching Question 3 #}
                {% set question_number = 3 %}
                {% set question_text = "I would personally take action in support of this issue." %}
                {% include 'opinion_slider_content.html' with context %}
                
                {# Matching Question 4 #}
                {% set question_number = 4 %}
                {% set question_text = "I think this issue has an overall positive impact on society." %}
                {% include 'opinion_slider_content.html' with context %}
                
                {# Matching Question 5 #}
                {% set question_number = 5 %}
                {% set question_text = "I believe this topic deserves more public attention." %}
                {% include 'opinion_slider_content.html' with context %}
                
                {# Matching Question 6 #}
                {% set question_number = 6 %}
                {% set question_text = "I trust the experts or authorities who promote this topic." %}
                {% include 'opinion_slider_content.html' with context %}
                
                {# Matching Question 7 #}
                {% set question_number = 7 %}
                {% set question_text = "I feel emotionally connected to this issue." %}
                {% include 'opinion_slider_content.html' with context %}
                
                {# Matching Question 8 #}
                {% set question_number = 8 %}
                {% set question_text = "I think opposing views on this topic are often based on misunderstanding." %}
                {% include 'opinion_slider_content.html' with context %}
                
                {# Matching Question 9 #}
                {% set question_number = 9 %}
                {% set question_text = "I believe addressing this issue should be a priority." %}
                {% include 'opinion_slider_content.html' with context %}
                
                {# Matching Question 10 #}
                {% set question_number = 10 %}
                {% set question_text = "I think this topic aligns with my personal values." %}
                {% include 'opinion_slider_content.html' with context %}


                <div class="d-grid gap-2 col-6 mx-auto mt-5">
                    <button class="btn btn-primary btn-lg" type="submit">Proceed to Demographics</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block javascript %}
<script type="text/javascript">
    // Function to update the displayed value next to the slider thumb
    function updateSliderValue(sliderId) {
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById('current-value-' + sliderId);
        if (slider && valueDisplay) {
            valueDisplay.textContent = slider.value;
        }
    }

    // Initialize values and attach event listeners dynamically
    document.addEventListener('DOMContentLoaded', () => {
        // Auto-discover all slider inputs - no manual ID maintenance needed
        const sliders = document.querySelectorAll('input[type="range"]');
        
        sliders.forEach(slider => {
            // Initial update
            updateSliderValue(slider.id);
            // Attach event listener for real-time update
            slider.addEventListener('input', () => updateSliderValue(slider.id));
        });
    });
</script>
{% endblock %}