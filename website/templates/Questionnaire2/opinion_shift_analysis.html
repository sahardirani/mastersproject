<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opinion Shift Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .shift-positive {
            color: #198754;
            font-weight: bold;
        }

        .shift-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .shift-neutral {
            color: #6c757d;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .openness-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
        }
    </style>
</head>

<body>
    <!-- Hidden data container for JavaScript -->
    <div id="chartData" 
         data-questions='{{ questions|tojson|safe }}'
         data-before='{{ before_values|tojson|safe }}'
         data-after='{{ after_values|tojson|safe }}'
         data-shifts='{{ shifts|tojson|safe }}'
         style="display: none;">
    </div>

    <section class="py-3 text-center container">
        <div class="row py-lg-4">
            <div class="col-lg-8 mx-auto">
                <h1 class="fw-light">Your Opinion Journey</h1>
                <p class="lead text-body-secondary">
                    See how your perspective evolved through the discussion on
                    <strong>{% if user.topic %}{{ user.topic }}{% else %}the selected topic{% endif %}</strong>
                </p>
            </div>
        </div>
    </section>

    <div class="album py-3 bg-body-tertiary">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 mx-auto">

                    <!-- Two-Column Layout for Metrics -->
                    <div class="row mb-4">
                        <!-- Overall Shift Summary -->
                        <div class="col-md-6 mb-3">
                            <div class="card shadow-sm metric-card h-100">
                                <div class="card-body text-center p-4">
                                    <h3 class="mb-3">Overall Opinion Shift</h3>
                                    <div class="display-4 mb-2">
                                        {% if avg_shift is not none %}
                                            {{ "+" if avg_shift > 0 else "" }}{{ "%.2f"|format(avg_shift) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                    <p class="mb-0">
                                        {% if avg_shift is not none %}
                                            {% if avg_shift > 0 %}
                                                Your views became more positive after the discussion
                                            {% elif avg_shift < 0 %}
                                                Your views became more negative after the discussion
                                            {% else %}
                                                Your views remained unchanged after the discussion
                                            {% endif %}
                                        {% else %}
                                            No shift data available
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Openness Score Card -->
                        <div class="col-md-6 mb-3">
                            <div class="card shadow-sm openness-card h-100">
                                <div class="card-body text-center p-4">
                                    <h3 class="mb-3">Your Openness Score</h3>
                                    <div class="display-4 mb-2">
                                        {% if openness_score is not none %}
                                            {{ "%.1f"|format(openness_score) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </div>
                                    <p class="mb-0">
                                        Category: <strong>
                                            {% if openness_category %}
                                                {{ openness_category }}
                                            {% else %}
                                                Unknown
                                            {% endif %}
                                        </strong>
                                    </p>
                                    <small class="mt-2 d-block opacity-75">
                                        Based on your initial questionnaire responses
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Line Chart: Before vs After -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h4 class="card-title mb-4">Before vs After Discussion</h4>
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>

                    <!-- Bar Chart: Detailed Question-by-Question Shift -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h4 class="card-title mb-3">Questions Reference</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li class="mb-2"><strong>Q1:</strong> I generally support the main idea or goal of this topic.</li>
                                        <li class="mb-2"><strong>Q2:</strong> I believe the benefits of this topic outweigh its risks.</li>
                                        <li class="mb-2"><strong>Q3:</strong> I would personally take action in support of this issue.</li>
                                        <li class="mb-2"><strong>Q4:</strong> I think this issue has an overall positive impact on society.</li>
                                        <li class="mb-2"><strong>Q5:</strong> I believe this topic deserves more public attention.</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="list-unstyled mb-0">
                                        <li class="mb-2"><strong>Q6:</strong> I trust the experts or authorities who promote this topic.</li>
                                        <li class="mb-2"><strong>Q7:</strong> I feel emotionally connected to this issue.</li>
                                        <li class="mb-2"><strong>Q8:</strong> I think opposing views on this topic are often based on misunderstanding.</li>
                                        <li class="mb-2"><strong>Q9:</strong> I believe addressing this issue should be a priority.</li>
                                        <li class="mb-2"><strong>Q10:</strong> I think this topic aligns with my personal values.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grouped Bar Chart: Before/After Comparison -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h4 class="card-title mb-4">Detailed Before/After Comparison</h4>
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <a href="{{ url_for('views.closing') }}" class="btn btn-primary btn-lg">Continue</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get data from HTML data attributes
            const dataContainer = document.getElementById('chartData');
            const questionsData = JSON.parse(dataContainer.getAttribute('data-questions'));
            const beforeData = JSON.parse(dataContainer.getAttribute('data-before'));
            const afterData = JSON.parse(dataContainer.getAttribute('data-after'));
            const shiftsData = JSON.parse(dataContainer.getAttribute('data-shifts'));

            const labels = questionsData.map((q, i) => 'Q' + (i + 1));

            const valueMap = {
                "-2": 'Strongly Disagree',
                "-1": 'Disagree',
                "0": 'Neutral',
                "1": 'Agree',
                "2": 'Strongly Agree'
            };

        // 1. Line Chart: Before vs After
        const lineCtx = document.getElementById('lineChart');
        if (lineCtx) {
            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Before Discussion',
                            data: beforeData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            tension: 0.3
                        },
                        {
                            label: 'After Discussion',
                            data: afterData,
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function (ctx) {
                                    return questionsData[ctx[0].dataIndex];
                                },
                                label: function (context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${valueMap[value] ?? value}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: -2,
                            max: 2,
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return valueMap[value] ?? value;
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // 2. Grouped Bar Chart: Before/After Comparison
        const comparisonCtx = document.getElementById('comparisonChart');
        if (comparisonCtx) {
            new Chart(comparisonCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Before Discussion',
                            data: beforeData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 2
                        },
                        {
                            label: 'After Discussion',
                            data: afterData,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgb(153, 102, 255)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function (ctx) {
                                    return questionsData[ctx[0].dataIndex];
                                },
                                label: function (context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${valueMap[value] ?? value}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: -2,
                            max: 2,
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return valueMap[value] ?? value;
                                }
                            },
                            title: {
                                display: true,
                                text: 'Agreement Level'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Questions'
                            }
                        }
                    }
                }
            });
        }
});
    </script>

</body>

</html>