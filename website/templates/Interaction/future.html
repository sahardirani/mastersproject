{% extends "base.html" %}
{% block titel %}Interaction Part 3{% endblock %}
{% block content %}

{% set topic = user.topic %}

{% if topic == 'climate' %}
    {% set round_title = "Consequences of Climate Activism" %}
    {% set intro_topic = "Effects of protest actions on citizens and politics" %}
{% elif topic == 'ai_employment' %}
    {% set round_title = "Future of Work with AI" %}
    {% set intro_topic = "Long-term consequences of AI for society, fairness and opportunities" %}
{% elif topic == 'freedom_speech' %}
    {% set round_title = "Future of Free Speech Online" %}
    {% set intro_topic = "Long-term consequences of social media for democracy and public debate" %}
{% else %}
    {% set round_title = topic|capitalize|replace('_', ' ') %}
    {% set intro_topic = "The selected topic" %}
{% endif %}

<section class="py-3 text-center container">
  <div class="row py-lg-3">
    <h1 class="fw-light">
      <span data-i18n="round3_title_prefix">Discussion Round 3:</span>
      {{ round_title }}
    </h1>
    <div class="col-lg-9 col-md-9 mx-auto">
      <p class="lead text-body-secondary">
        <span data-i18n="round3_intro_prefix">
          Welcome to the third discussion round.
        </span><br>
        <b>
          <span data-i18n="round3_focus_prefix">Discussion focus:</span>
          {{ intro_topic }}
        </b>
      </p>
    </div>
  </div>
</section>

<div class="album py-5 bg-body-tertiary">
  <div class="row align-items-center justify-content-center">
    <div class="col-lg-6 col-md-10 col-sm-12">
      <div>
        <div id="jitsi-container"></div>
        <div id="flash-message" class="flash-message" style="display: none;">
          <span data-i18n="round3_flash_message">You have 1 minute left.</span>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-8 col-sm-12">
      <div class="d-grid gap-2 text-center">
        <h2 class="fw-light" data-i18n="round3_prompts_title">Discussion Prompts</h2>
        <ul class="list-group d-grid gap-2">

  {% if topic == 'climate' %}
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_climate_q1">
      <b>1. What impact do you think very disruptive climate activism has on ordinary citizens?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_climate_q2">
      <b>2. Do you think climate activism is effective in changing political decisions?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_climate_q3">
      <b>3. In your view, what would be the most effective ways to fight climate change?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_climate_q4">
      <b>4. Is there anything you would still like to tell or ask your conversation partner?</b>
    </li>

  {% elif topic == 'ai_employment' %}
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_ai_q1">
      <b>1. Who do you think will benefit most from AI in the long run, and who might lose out?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_ai_q2">
      <b>2. What political or social measures would you like to see to make the AI transition fairer?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_ai_q3">
      <b>3. How do you imagine an ideal future in which humans and AI work together?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_ai_q4">
      <b>4. Is there anything you would still like to tell or ask your conversation partner?</b>
    </li>

  {% elif topic == 'freedom_speech' %}
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_speech_q1">
      <b>1. What impact do you think social media will have on democracy and public debate in the long term?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_speech_q2">
      <b>2. What kind of regulation (if any) would you like to see for social media platforms in the future?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_speech_q3">
      <b>3. How could we protect freedom of speech while also protecting people from harm online?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_speech_q4">
      <b>4. Is there anything you would still like to tell or ask your conversation partner?</b>
    </li>

  {% else %}
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_generic_q1">
      <b>1. What long-term consequences do you expect from how this topic is handled today?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_generic_q2">
      <b>2. What changes would you personally like to see in the future?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_generic_q3">
      <b>3. What could be done to reduce conflict and increase understanding around this topic?</b>
    </li>
    <li class="list-group-item lead text-body-secondary"
        data-i18n="round3_generic_q4">
      <b>4. Is there anything you would still like to tell or ask your conversation partner?</b>
    </li>
  {% endif %}

</ul>

      </div>
    </div>
  </div>
</div>

<script src="https://meet.jit.si/external_api.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("Part 3 loaded");

    let api = null;
    let timersStarted = false;

    function timerCallback() {
        console.log("Part 3: timer fired â†’ go to post-match questionnaire");
        if (api) {
            api.dispose();
        }
        window.location.href = "{{ url_for('views.post_match_questionnaire') }}";
    }

    function showFlashMessage() {
        console.log("Part 3: flash message shown");
        const el = document.getElementById('flash-message');
        if (el) el.style.display = 'block';
    }

    function startDiscussionTimers() {
        if (timersStarted) return;
        timersStarted = true;
        console.log("Part 3: starting discussion timers (5 min, 4 min warning)");
        setTimeout(timerCallback, 300000);    // 5:00 total
        setTimeout(showFlashMessage, 240000); // 4:00 warning
    }

    function checkAndStartTimers() {
        if (!api) return;
        try {
            const count = api.getNumberOfParticipants(); // incl. yourself
            console.log("Part 3: participant count =", count);
            if (count >= 2) {
                startDiscussionTimers();
            }
        } catch (e) {
            console.error("Part 3: error getting participant count:", e);
        }
    }

    try {
        const meetingid = "{{ user.meeting_id }}";
        const room_name = 'Part Three ' + meetingid;

        api = new JitsiMeetExternalAPI('meet.jit.si', {
            roomName: room_name,
            width: '100%',
            height: 500,
            parentNode: document.querySelector('#jitsi-container')
        });

        // When YOU join
        api.addListener('videoConferenceJoined', (event) => {
            console.log("Part 3: videoConferenceJoined", event);
            checkAndStartTimers();
        });

        // When your PARTNER joins
        api.addListener('participantJoined', (event) => {
            console.log("Part 3: participantJoined", event);
            checkAndStartTimers();
        });

    } catch (e) {
        console.error("Jitsi init failed in Part 3:", e);
    }
});
</script>

{% endblock %}
